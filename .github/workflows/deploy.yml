name: Deploy to Local Kubernetes

on:
  push:
    branches: [ main, master, develop, feature/* ]
  pull_request:
    branches: [ main, master ]

env:
  KUBECONFIG: /home/neto/.kube/config_cluster_local

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
          
      - name: Login to Docker Hub
        run: |
          echo "Logging in to Docker Hub..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
      - name: Build and push to Docker Hub
        run: |
          echo "Building and pushing to Docker Hub..."
          
          # Converter nome da branch para tag válida (substitui / por -)
          BRANCH_TAG=$(echo "${{ github.ref_name }}" | tr '/' '-')
          echo "Branch tag: $BRANCH_TAG"
          
          # Build da imagem
          docker build -t netinhos89/local-app:$BRANCH_TAG .
          
          # Se for main/master, também criar tag latest
          if [[ "${{ github.ref_name }}" == "main" || "${{ github.ref_name }}" == "master" ]]; then
            docker tag netinhos89/local-app:$BRANCH_TAG netinhos89/local-app:latest
            docker push netinhos89/local-app:latest
          fi
          
          # Push da tag da branch
          docker push netinhos89/local-app:$BRANCH_TAG
          
          echo "Image pushed successfully as: netinhos89/local-app:$BRANCH_TAG"
          
      - name: Deploy to Kubernetes
        if: github.ref_name == 'main' || github.ref_name == 'master'
        run: |
          echo "Deploying to Kubernetes..."
          kubectl apply -f k8s/
          
          kubectl wait --for=condition=Ready namespace/local-app --timeout=60s || true
          
          # Deploy com tag da branch
          BRANCH_TAG=$(echo "${{ github.ref_name }}" | tr '/' '-')
          kubectl set image deployment/local-app app=netinhos89/local-app:$BRANCH_TAG -n local-app
          
          kubectl rollout status deployment/local-app -n local-app --timeout=300s
          
      - name: Verify deployment
        if: github.ref_name == 'main' || github.ref_name == 'master'
        run: |
          echo "Verifying deployment..."
          kubectl get pods -n local-app
          kubectl get service -n local-app