name: Deploy to Local Kubernetes

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  KUBECONFIG: /home/neto/.kube/config_cluster_local

jobs:
  build-and-deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Test environment
        run: |
          echo "Testing environment..."
          echo "Using KUBECONFIG: $KUBECONFIG"
          kubectl config current-context
          kubectl cluster-info
          echo "Docker version:"
          docker --version
          echo "Containerd version:"
          ctr version
          echo "Available namespaces:"
          ctr namespaces list
          
      - name: Login to Docker Hub
        run: |
          echo "Logging in to Docker Hub..."
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
      - name: Build and push to Docker Hub
        run: |
          echo "Building and pushing to Docker Hub..."
          # Build da imagem
          docker build -t netinhos89/local-app:${{ github.sha }} .
          docker tag netinhos89/local-app:${{ github.sha }} netinhos89/local-app:latest
          
          # Push para Docker Hub
          docker push netinhos89/local-app:${{ github.sha }}
          docker push netinhos89/local-app:latest
          
          echo "Image pushed to Docker Hub successfully"
          
      - name: Deploy to Kubernetes
        run: |
          echo "Deploying to Kubernetes..."
          kubectl apply -f k8s/
          
          # Aguardar namespace ser criado
          kubectl wait --for=condition=Ready namespace/local-app --timeout=60s || true
          
          # Atualizar imagem do deployment
          kubectl set image deployment/local-app app=netinhos89/local-app:${{ github.sha }} -n local-app
          
          # Aguardar rollout
          kubectl rollout status deployment/local-app -n local-app --timeout=300s
          
      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          kubectl get pods -n local-app
          kubectl get service -n local-app
          
          # Mostrar logs dos pods
          echo "Application logs:"
          kubectl logs -n local-app -l app=local-app --tail=20